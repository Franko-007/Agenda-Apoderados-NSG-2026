<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Agenda Apoderados – Liceo Bicentenario NSG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8;text-align:center;}
        header{ background:#013b7a; color:white; padding:15px; display:flex; flex-direction:column; align-items:center; gap:10px; }
        header img{height:50px;}
        header h1{font-size:20px;margin:0;}
        main{ padding:20px; display:flex; flex-direction:column; align-items:center; }
        #viewControls{ margin-bottom:15px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; }
        select, button{ padding:6px 12px; border-radius:4px; border:none; cursor:pointer; }
        #monthNav{ display:flex; justify-content:space-between; align-items:center; width:98%; max-width:1300px; margin-bottom:10px; }
        .calendar{ width:98%; max-width:1300px; margin:0 auto; }
        .month-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
        .day-name { font-weight: bold; background: #013b7a; color: white; padding: 10px 0; border-radius: 4px; font-size: 12px; text-transform: uppercase; }
        .day{ background:white; border-radius:6px; padding:4px; min-height:120px; box-shadow:0 1px 3px rgba(0,0,0,.15); position:relative; font-size:11px; cursor:pointer; }
        .day h3{ text-align:right; font-size:11px; margin:0; }
        .event{ position:relative; margin-top:2px; font-size:10px; padding:4px; border-radius:3px; color:white; overflow:hidden; cursor:pointer; text-align:left; border-left: 4px solid rgba(0,0,0,0.2); }
        .event.asistio { background: #2e7d32 !important; border-left: 4px solid #1b5e20; }
        .event.asistio::before { content: "✔ "; font-weight: bold; }
        .event.no-asistio { background: #757575 !important; border-left: 4px solid #b71c1c; text-decoration: line-through; opacity: 0.8; }
        .event.no-asistio::before { content: "✘ "; font-weight: bold; }
        .feriado{ background:#ffe5e5 !important; border:2px solid #d32f2f; }
        .feriado-label{ font-size:9px; color:#b71c1c; font-weight:bold; }
        #legend{ margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
        .legend-item{ display:flex; align-items:center; gap:5px; font-size:12px; }
        .legend-color{ width:14px; height:14px; border-radius:3px; }
        canvas{ margin-top:20px; background:white; border-radius:6px; padding:10px; max-width: 100%; }
        dialog{ border:none; border-radius:8px; padding:20px; width: 320px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        dialog h3 { margin-top: 0; color: #013b7a; }
        dialog label { display: block; text-align: left; font-size: 11px; margin-top: 10px; font-weight: bold; }
        dialog input, dialog select{ width:100%; margin-bottom:5px; padding:8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .btn-save { background: #013b7a; color: white; cursor: pointer; }
        .btn-delete { background: #c62828; color: white; cursor: pointer; }
        footer{ margin-top:20px; font-size:12px; padding-bottom: 20px;}
    </style>
</head>
<body>
    <header>
        <img src="logo.png" alt="Logo Institucional">
        <h1>Atención de Apoderados 2026<br>Liceo Bicentenario Nuestra Señora de Guadalupe</h1>
    </header>
    <main>
        <div id="viewControls">
            <label>Docente:</label>
            <select id="filterDocente"></select>
            <label>Mes:</label>
            <select id="filterMes"></select>
            <label>Año:</label>
            <select id="filterYear"></select>
        </div>
        <div id="monthNav">
            <button onclick="prevMonth()">« Anterior</button>
            <div id="monthLabel"></div>
            <button onclick="nextMonth()">Siguiente »</button>
        </div>
        <div id="calendar" class="calendar"></div>
        <div id="legend"></div>
        <canvas id="chart" width="600" height="250"></canvas>

        <dialog id="dialog">
            <h3>Gestionar Cita</h3>
            <input type="hidden" id="citaId">
            <label>Fecha y Hora:</label>
            <input type="date" id="fecha">
            <input type="time" id="hora" step="1800">
            <label>Información:</label>
            <input type="text" id="docente" placeholder="Docente">
            <input type="text" id="curso" placeholder="Curso">
            <input type="text" id="alumno" placeholder="Alumno">
            <input type="text" id="apoderado" placeholder="Apoderado">
            <label>Estado de Asistencia:</label>
            <select id="estado">
                <option value="Pendiente">Pendiente</option>
                <option value="Asistió">Asistió ✅</option>
                <option value="No Asistió">No Asistió ❌</option>
            </select>
            <div class="btn-group">
                <button id="btnGuardar" class="btn-save" onclick="guardar()">Guardar Cambios</button>
                <button class="btn-delete" onclick="eliminar()">Eliminar Cita</button>
                <button onclick="closeDialog()">Cancelar</button>
            </div>
        </dialog>
    </main>
    <footer>Todos los derechos reservados – NSG | Por Franco.</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const SHEET_URL="https://script.google.com/macros/s/AKfycbwTVXOjI9FZALroFF3XchBgzuQcCf7LYJhdtOr1QOo1a7FXIeNQTjs9FkssJYSw9IfC/exec";
    let citas=[];
    let currentDate=new Date();
    const calendar=document.getElementById("calendar");
    const monthLabel=document.getElementById("monthLabel");
    const legendDiv=document.getElementById("legend");
    const filterDocente=document.getElementById("filterDocente");
    const filterMes=document.getElementById("filterMes");
    const filterYear=document.getElementById("filterYear");
    const colors=["#1976d2","#388e3c","#f57c00","#7b1fa2","#c62828"];
    let docenteColors={};
    const diasSemana = ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"];

    function calcularPascua(year){
        const f=Math.floor; const G=year%19; const C=f(year/100);
        const H=(C-f(C/4)-f((8*C+13)/25)+19*G+15)%30;
        const I=H-f(H/28)*(1-f(29/(H+1))*f((21-G)/11));
        const J=(year+f(year/4)+I+2-C+f(C/4))%7;
        const L=I-J; const month=3+f((L+40)/44); const day=L+28-31*f(month/4);
        return new Date(year,month-1,day);
    }

    function feriadosChile(year){
        const pascua=calcularPascua(year);
        const feriados={
            [`${year}-01-01`]:"Año Nuevo", [`${year}-05-01`]:"Día del Trabajador",
            [`${year}-05-21`]:"Glorias Navales", [`${year}-07-16`]:"Virgen del Carmen",
            [`${year}-08-15`]:"Asunción de la Virgen", [`${year}-09-18`]:"Independencia",
            [`${year}-09-19`]:"Glorias Ejército", [`${year}-10-12`]:"Encuentro Mundos",
            [`${year}-10-31`]:"Iglesias Evangélicas", [`${year}-11-01`]:"Todos los Santos",
            [`${year}-12-08`]:"Inmaculada Concepción", [`${year}-12-25`]:"Navidad",
            [new Date(pascua.getTime()-2*86400000).toISOString().slice(0,10)]:"Viernes Santo",
            [new Date(pascua.getTime()-1*86400000).toISOString().slice(0,10)]:"Sábado Santo"
        };
        let d=new Date(year,0,1);
        while(d.getFullYear()===year){
            if(d.getDay()===0){ feriados[d.toISOString().slice(0,10)]="Domingo"; }
            d.setDate(d.getDate()+1);
        }
        return feriados;
    }

    function initFilters(){
        filterDocente.innerHTML='<option value="">Todos los Docentes</option>';
        for(let i=0;i<12;i++) filterMes.innerHTML+=`<option value="${i}">${new Date(0,i).toLocaleString("es",{month:"long"})}</option>`;
        for(let y=currentDate.getFullYear()-1;y<=currentDate.getFullYear()+1;y++) filterYear.innerHTML+=`<option value="${y}">${y}</option>`;
        filterMes.value=currentDate.getMonth();
        filterYear.value=currentDate.getFullYear();
        filterMes.onchange=syncDate; filterYear.onchange=syncDate; filterDocente.onchange=renderCalendar;
    }

    function syncDate(){ currentDate=new Date(filterYear.value,filterMes.value,1); renderCalendar(); }

    async function cargarCitas(){
        try {
            const r=await fetch(SHEET_URL+"?action=get");
            const res=await r.json();
            citas=res.datos || [];
            docenteColors={};
            citas.forEach(c=>{
                if(c.docente && !docenteColors[c.docente]) 
                    docenteColors[c.docente]=colors[Object.keys(docenteColors).length%colors.length];
            });
            renderFiltroDocentes(); renderCalendar(); renderLegend(); renderChart();
        } catch(e) { console.error("Error:", e); }
    }

    function renderFiltroDocentes(){
        const sel=filterDocente.value;
        filterDocente.innerHTML='<option value="">Todos los Docentes</option>';
        Object.keys(docenteColors).forEach(d=>{ filterDocente.innerHTML+=`<option value="${d}">${d}</option>`; });
        filterDocente.value=sel;
    }

    function prevMonth(){currentDate.setMonth(currentDate.getMonth()-1);syncUI();}
    function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);syncUI();}
    function syncUI(){ filterMes.value=currentDate.getMonth(); filterYear.value=currentDate.getFullYear(); renderCalendar(); }

    function renderCalendar(){
        calendar.innerHTML="";
        const m=currentDate.getMonth(); const y=currentDate.getFullYear();
        const feriados=feriadosChile(y);
        monthLabel.textContent=currentDate.toLocaleString("es",{month:"long",year:"numeric"});
        const grid=document.createElement("div");
        grid.className="month-grid";
        diasSemana.forEach(dia => {
            const dDiv = document.createElement("div"); dDiv.className = "day-name";
            dDiv.textContent = dia; grid.appendChild(dDiv);
        });
        let first=(new Date(y,m,1).getDay()+6)%7;
        const days=new Date(y,m+1,0).getDate();
        for(let i=0;i<first;i++) grid.appendChild(document.createElement("div"));
        for(let d=1;d<=days;d++){
            const dateStr=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
            const cell=document.createElement("div");
            cell.className="day";
            cell.innerHTML=`<h3>${d}</h3>`;
            cell.onclick=()=>openDialog(dateStr);
            if(feriados[dateStr]){
                cell.classList.add("feriado");
                cell.innerHTML+=`<div class="feriado-label">${feriados[dateStr]}</div>`;
            }
            citas.filter(c => {
                let cf = String(c.fecha); if(cf.includes("T")) cf = cf.split("T")[0];
                return cf === dateStr && (!filterDocente.value || c.docente === filterDocente.value);
            }).forEach(c=>{
                const ev=document.createElement("div");
                ev.className="event";
                if(c.estado === "Asistió") ev.classList.add("asistio");
                else if(c.estado === "No Asistió") ev.classList.add("no-asistio");
                ev.style.background=docenteColors[c.docente] || "#999";
                
                // LÓGICA DE LIMPIEZA DE HORA PARA EVITAR EL CÓDIGO 1899
                let horaTxt = String(c.hora);
                if(horaTxt.includes("T")) {
                    horaTxt = horaTxt.split("T")[1].substring(0,5);
                } else if(horaTxt.length > 5) {
                    horaTxt = horaTxt.substring(0,5);
                }

                ev.textContent=`${horaTxt} - ${c.alumno}`;
                ev.onclick=e=>{e.stopPropagation();openDialog(c.fecha,c.hora,c);};
                cell.appendChild(ev);
            });
            grid.appendChild(cell);
        }
        calendar.appendChild(grid);
    }

    function openDialog(f,h="08:00",c=null){
        document.getElementById("citaId").value=c?.id||"";
        document.getElementById("fecha").value=f.includes("T") ? f.split("T")[0] : f;
        
        // Limpiamos la hora para el input del modal
        let horaInput = String(h);
        if(horaInput.includes("T")) horaInput = horaInput.split("T")[1].substring(0,5);
        document.getElementById("hora").value=horaInput;
        
        document.getElementById("docente").value=c?.docente||"";
        document.getElementById("curso").value=c?.curso||"";
        document.getElementById("alumno").value=c?.alumno||"";
        document.getElementById("apoderado").value=c?.apoderado||"";
        document.getElementById("estado").value=c?.estado||"Pendiente";
        document.getElementById("dialog").showModal();
    }

    function closeDialog(){document.getElementById("dialog").close();}

    async function guardar(){
        const btn = document.getElementById("btnGuardar");
        btn.disabled = true;
        btn.textContent = "Guardando...";
        
        const params=new URLSearchParams({
            action:document.getElementById("citaId").value?"edit":"add",
            id:document.getElementById("citaId").value,
            fecha:document.getElementById("fecha").value,
            hora:document.getElementById("hora").value,
            docente:document.getElementById("docente").value,
            curso:document.getElementById("curso").value,
            alumno:document.getElementById("alumno").value,
            apoderado:document.getElementById("apoderado").value,
            estado:document.getElementById("estado").value
        });
        
        try {
            await fetch(SHEET_URL+"?"+params, { mode: 'no-cors' });
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "Guardar Cambios";
                closeDialog(); 
                cargarCitas();
            }, 1500);
        } catch(e) {
            console.error(e);
            btn.disabled = false;
            btn.textContent = "Guardar Cambios";
        }
    }

    async function eliminar(){
        if(!confirm("¿Eliminar cita?")) return;
        const id = document.getElementById("citaId").value;
        await fetch(`${SHEET_URL}?action=delete&id=${id}`, { mode: 'no-cors' });
        setTimeout(() => { cargarCitas(); closeDialog(); }, 1000);
    }

    function renderLegend(){
        legendDiv.innerHTML="";
        Object.keys(docenteColors).forEach(d=>{
            legendDiv.innerHTML+=`<div class="legend-item"><div class="legend-color" style="background:${docenteColors[d]}"></div>${d}</div>`;
        });
    }

    function renderChart(){
        const ctx=document.getElementById("chart").getContext("2d");
        if(window.chart)window.chart.destroy();
        window.chart=new Chart(ctx,{
            type:"bar",
            data:{
                labels:Object.keys(docenteColors),
                datasets:[{
                    label: 'Citas por Docente',
                    data:Object.keys(docenteColors).map(d=>citas.filter(c=>c.docente===d).length),
                    backgroundColor:Object.values(docenteColors)
                }]
            },
            options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
        });
    }

    initFilters();
    cargarCitas();
</script>
</body>
</html>
