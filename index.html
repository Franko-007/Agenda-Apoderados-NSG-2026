<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda Apoderados – Liceo Bicentenario NSG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8;}
header{background:#0b4f6c;color:white;padding:15px;display:flex;align-items:center;gap:15px;flex-wrap:wrap;}
header img{height:50px;}
header h1{font-size:20px;margin:0;flex:1;}
main{padding:20px;}
#viewControls{margin-bottom:15px;display:flex;flex-wrap:wrap;gap:5px;}
button{padding:6px 12px;margin-right:5px;border:none;border-radius:4px;background:#0b4f6c;color:white;cursor:pointer;}
.calendar{display:grid;gap:5px;}
.day, .month-box{background:white;border-radius:6px;padding:5px;min-height:100px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.day h3,.month-box h3{text-align:center;font-size:14px;background:#eaeaea;padding:3px;border-radius:4px;margin:0;}
.event{color:white;font-size:12px;padding:2px 4px;border-radius:4px;margin-top:2px;cursor:pointer;display:block;}
footer{text-align:center;font-size:12px;color:#666;padding:10px;}
dialog{border:none;border-radius:8px;padding:20px;}
dialog input,dialog select{width:100%;margin-bottom:10px;padding:6px;}
.weekview{display:flex;flex-wrap:wrap;gap:5px;}
.weekday{flex:1;background:white;border-radius:6px;min-height:600px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
.weekday h4{text-align:center;font-size:14px;background:#eaeaea;padding:3px;border-radius:4px;margin:0;}
.block{height:28px;margin:1px 0;padding:2px 4px;border-radius:4px;color:white;font-size:11px;cursor:pointer;}
#legend{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;}
.legend-item{display:flex;align-items:center;gap:5px;font-size:12px;}
.legend-color{width:15px;height:15px;border-radius:3px;}
@media(max-width:768px){.calendar{grid-template-columns:1fr !important;}.weekview{flex-direction:column;}.weekday{min-height:300px;}}
</style>
</head>
<body>
<header>
<img src="logo.png" alt="Logo Institucional">
<h1>Agenda de Atención a Apoderados<br>Liceo Bicentenario Nuestra Señora de Guadalupe</h1>
</header>

<main>
<div id="viewControls">
<button onclick="setView('year')">Vista Año</button>
<button onclick="setView('month')">Vista Mes</button>
<button onclick="setView('week')">Vista Semana</button>
<button onclick="setView('day')">Vista Día</button>
<button onclick="openDialog()">➕ Agregar Cita (Administración)</button>
</div>

<div id="calendar" class="calendar"></div>
<div id="legend"></div>
</main>

<dialog id="dialog">
<h3>Nueva cita</h3>
<input type="date" id="fecha"/>
<input type="time" id="hora"/>
<input type="text" id="docente" placeholder="Docente"/>
<input type="text" id="curso" placeholder="Curso"/>
<input type="text" id="alumno" placeholder="Nombre del Alumno"/>
<input type="text" id="apoderado" placeholder="Nombre del Apoderado"/>
<button onclick="guardar()">Guardar</button>
<button onclick="closeDialog()">Cancelar</button>
</dialog>

<footer>
Todos los derechos reservados – NSG 2026 | Por Franco.
</footer>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycby6YisLVdrmltjB8Bn6g6sTFetq1enRYAXlioWtfdMTeZlX9IGRmdPAjBc7kMaVnVl8/exec";

let citas = [];
let view = 'month';
const calendar = document.getElementById('calendar');
const legendDiv = document.getElementById('legend');

const colors = ["#4caf50","#ff9800","#2196f3","#9c27b0","#f44336","#3f51b5","#00bcd4","#e91e63","#ff5722"];
const docenteColors = {};

function getColor(docente){
  if(docenteColors[docente]) return docenteColors[docente];
  const color = colors[Object.keys(docenteColors).length % colors.length];
  docenteColors[docente] = color;
  return color;
}

function renderLegend(){
  legendDiv.innerHTML = '';
  Object.keys(docenteColors).forEach(d=>{
    const item = document.createElement('div');
    item.className='legend-item';
    item.innerHTML = `<div class="legend-color" style="background:${docenteColors[d]}"></div>${d}`;
    legendDiv.appendChild(item);
  });
}

async function cargarCitas(){
  try {
    const response = await fetch(`${SHEET_URL}?action=get`);
    citas = await response.json();
    renderCalendar();
    renderLegend();
  } catch(e) {
    console.error("Error cargando citas:", e);
    alert("No se pudieron cargar las citas. Verifica la URL del Web App.");
  }
}

function setView(v){
  view = v;
  renderCalendar();
}

// ------------------- RENDER CALENDAR -------------------
function renderCalendar(){
  calendar.innerHTML='';
  const today = new Date();
  if(view==='year') renderYearView(today);
  if(view==='month') renderMonthView(today);
  if(view==='week') renderWeekView(today);
  if(view==='day') renderDayView(today);
}

// ---------------- YEAR VIEW ----------------
function renderYearView(today){
  calendar.className='calendar';
  calendar.style.gridTemplateColumns='repeat(4,1fr)';
  for(let m=0;m<12;m++){
    const monthBox=document.createElement('div');
    monthBox.className='month-box';
    monthBox.innerHTML=`<h3>${new Date(today.getFullYear(),m,1).toLocaleDateString('es-CL',{month:'long'})}</h3>`;
    const daysInMonth = new Date(today.getFullYear(), m+1,0).getDate();
    for(let d=1;d<=daysInMonth;d++){
      const dayDiv=document.createElement('div');
      const cita = citas.filter(c => new Date(c.fecha).getDate()===d && new Date(c.fecha).getMonth()===m);
      cita.forEach(c=>{
        const ev=document.createElement('div');
        ev.className='event';
        ev.style.backgroundColor=getColor(c.docente);
        ev.textContent=`${c.hora} ${c.docente}`;
        ev.title = `Alumno: ${c.alumno}\nApoderado: ${c.apoderado}\nDocente: ${c.docente}\nCurso: ${c.curso}`;
        dayDiv.appendChild(ev);
      });
      monthBox.appendChild(dayDiv);
    }
    calendar.appendChild(monthBox);
  }
}

// --------------- MONTH VIEW ----------------
function renderMonthView(today){
  const month = today.getMonth();
  const year = today.getFullYear();
  const firstDay = new Date(year, month,1).getDay();
  const daysInMonth = new Date(year, month+1,0).getDate();
  calendar.className='calendar';
  calendar.style.gridTemplateColumns='repeat(7,1fr)';
  for(let i=0;i<firstDay;i++) calendar.appendChild(document.createElement('div'));
  for(let d=1; d<=daysInMonth; d++){
    const dayDiv=document.createElement('div');
    dayDiv.className='day';
    dayDiv.innerHTML=`<h3>${d}</h3>`;
    citas.filter(c => new Date(c.fecha).getDate()===d && new Date(c.fecha).getMonth()===month)
         .forEach(c=>{
           const ev=document.createElement('div');
           ev.className='event';
           ev.style.backgroundColor = getColor(c.docente);
           ev.textContent=`${c.hora} – ${c.docente}`;
           ev.title = `Alumno: ${c.alumno}\nApoderado: ${c.apoderado}\nDocente: ${c.docente}\nCurso: ${c.curso}`;
           dayDiv.appendChild(ev);
         });
    calendar.appendChild(dayDiv);
  }
}

// --------------- WEEK & DAY VIEW ----------------
function renderWeekView(today){ renderTimeBlocksView(today,7); }
function renderDayView(today){ renderTimeBlocksView(today,1); }

function renderTimeBlocksView(today, daysCount){
  calendar.className='weekview';
  const start = new Date(today);
  if(daysCount===7) start.setDate(today.getDate() - today.getDay());
  for(let i=0;i<daysCount;i++){
    const day = new Date(start);
    day.setDate(start.getDate()+i);
    const wd=document.createElement('div');
    wd.className='weekday';
    wd.innerHTML=`<h4>${day.toLocaleDateString('es-CL',{weekday:'long',day:'numeric'})}</h4>`;
    for(let h=8;h<18;h++){
      for(let m=0;m<60;m+=30){
        const block=document.createElement('div');
        block.className='block';
        block.dataset.time=`${('0'+h).slice(-2)}:${('0'+m).slice(-2)}`;
        block.dataset.date = day.toISOString().split('T')[0];
        const cita = citas.find(c => c.fecha===block.dataset.date && c.hora===block.dataset.time);
        if(cita){
          block.style.backgroundColor = getColor(cita.docente);
          block.textContent=cita.hora+" "+cita.docente;
          block.title = `Alumno: ${cita.alumno}\nApoderado: ${cita.apoderado}\nDocente: ${cita.docente}\nCurso: ${cita.curso}`;
        }
        block.addEventListener('click',()=>{
          document.getElementById('fecha').value = block.dataset.date;
          document.getElementById('hora').value = block.dataset.time;
          openDialog();
        });
        wd.appendChild(block);
      }
    }
    calendar.appendChild(wd);
  }
}

// ---------------- DIALOG ----------------
function openDialog(){ document.getElementById('dialog').showModal(); }
function closeDialog(){ document.getElementById('dialog').close(); }

async function guardar(){
  const fecha = document.getElementById('fecha').value;
  const hora = document.getElementById('hora').value;
  const docente = document.getElementById('docente').value.trim();
  const curso = document.getElementById('curso').value.trim();
  const alumno = document.getElementById('alumno').value.trim();
  const apoderado = document.getElementById('apoderado').value.trim();

  if(!fecha||!hora||!docente||!curso||!alumno||!apoderado){
    alert("Por favor, completa todos los campos.");
    return;
  }

  try{
    const resp = await fetch(`${SHEET_URL}?action=add&fecha=${fecha}&hora=${hora}&docente=${docente}&curso=${curso}&alumno=${alumno}&apoderado=${apoderado}&estado=Ocupado`);
    const text = await resp.text();
    if(text==="ok"){
      closeDialog();
      cargarCitas();
    } else {
      alert("Error guardando la cita: "+text);
    }
  } catch(e){
    console.error(e);
    alert("No se pudo conectar con Google Sheets. Verifica la URL del Web App.");
  }
}

cargarCitas();
setInterval(cargarCitas,10000); // Actualiza cada 10s
</script>
</body>
</html>
