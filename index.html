<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda Apoderados – Liceo Bicentenario NSG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f8;text-align:center;}
header{
  background:#004fa3;
  color:white;
  padding:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
header img{height:50px;}
header h1{font-size:20px;margin:0;}

main{
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

#viewControls{
  margin-bottom:15px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  justify-content:center;
  align-items:center;
}

select, button{
  padding:6px 12px;
  border-radius:4px;
  border:none;
  cursor:pointer;
}

#monthNav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:98%;
  max-width:1300px;
  margin-bottom:10px;
}

.calendar{
  width:98%;
  max-width:1300px;
  margin:0 auto;
}

.month-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:4px;
}

.day{
  background:white;
  border-radius:6px;
  padding:4px;
  min-height:180px;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
  position:relative;
  font-size:11px;
  cursor:pointer;
}

.day h3{
  text-align:right;
  font-size:11px;
  margin:0;
}

.event{
  position:absolute;
  left:3px;
  right:3px;
  font-size:10px;
  padding:2px 4px;
  border-radius:3px;
  color:white;
  overflow:hidden;
  cursor:pointer;
}

#legend{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:center;
}

.legend-item{
  display:flex;
  align-items:center;
  gap:5px;
  font-size:12px;
}

.legend-color{
  width:14px;
  height:14px;
  border-radius:3px;
}

canvas{
  margin-top:20px;
  background:white;
  border-radius:6px;
  padding:10px;
}

dialog{
  border:none;
  border-radius:8px;
  padding:20px;
}

dialog input{
  width:100%;
  margin-bottom:10px;
  padding:6px;
}

footer{
  margin-top:20px;
  font-size:12px;
}
</style>
</head>

<body>

<header>
<img src="logo.png" alt="Logo Institucional">
<h1>Atención de Apoderados 2026<br>Liceo Bicentenario Nuestra Señora de Guadalupe</h1>
</header>

<main>

<div id="viewControls">
<label>Docente:</label>
<select id="filterDocente"></select>

<label>Mes:</label>
<select id="filterMes"></select>

<label>Año:</label>
<select id="filterYear"></select>
</div>

<div id="monthNav">
<button onclick="prevMonth()">« Anterior</button>
<div id="monthLabel"></div>
<button onclick="nextMonth()">Siguiente »</button>
</div>

<div id="calendar" class="calendar"></div>
<div id="legend"></div>
<canvas id="chart" width="600" height="250"></canvas>

<dialog id="dialog">
<h3>Gestionar cita</h3>
<input type="hidden" id="citaId">
<input type="date" id="fecha">
<input type="time" id="hora" step="1800">
<input type="text" id="docente" placeholder="Docente">
<input type="text" id="curso" placeholder="Curso">
<input type="text" id="alumno" placeholder="Alumno">
<input type="text" id="apoderado" placeholder="Apoderado">
<button onclick="guardar()">Guardar</button>
<button onclick="eliminar()">Eliminar</button>
<button onclick="closeDialog()">Cancelar</button>
</dialog>

</main>

<footer>
Todos los derechos reservados – NSG 2026 | Por Franco.
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbyiXsD-41VaH4ShPDlreZUTu_bcW9apgGJtntj03oHL_LlfmYcTodLYcOq8N4q8Qvjs/exec";

let citas=[];
let currentDate=new Date();

const calendar=document.getElementById("calendar");
const monthLabel=document.getElementById("monthLabel");
const legendDiv=document.getElementById("legend");

const filterDocente=document.getElementById("filterDocente");
const filterMes=document.getElementById("filterMes");
const filterYear=document.getElementById("filterYear");

const colors=["#1976d2","#388e3c","#f57c00","#7b1fa2","#c62828"];
let docenteColors={};

/* ---------- INIT ---------- */
function initFilters(){
  filterDocente.innerHTML='<option value="">Todos</option>';

  filterMes.innerHTML='';
  for(let i=0;i<12;i++){
    filterMes.innerHTML+=`<option value="${i}">${new Date(0,i).toLocaleString("es",{month:"long"})}</option>`;
  }

  filterYear.innerHTML='';
  for(let y=currentDate.getFullYear()-3;y<=currentDate.getFullYear()+3;y++){
    filterYear.innerHTML+=`<option value="${y}">${y}</option>`;
  }

  filterMes.value=currentDate.getMonth();
  filterYear.value=currentDate.getFullYear();

  filterMes.onchange=syncDate;
  filterYear.onchange=syncDate;
  filterDocente.onchange=renderCalendar;
}

function syncDate(){
  currentDate=new Date(
    parseInt(filterYear.value),
    parseInt(filterMes.value),
    1
  );
  renderCalendar();
}

/* ---------- DATA ---------- */
async function cargarCitas(){
  const r=await fetch(SHEET_URL+"?action=get");
  citas=await r.json();

  docenteColors={};
  citas.forEach(c=>{
    if(!docenteColors[c.docente]){
      docenteColors[c.docente]=colors[Object.keys(docenteColors).length%colors.length];
    }
  });

  renderFiltroDocentes();
  renderCalendar();
  renderLegend();
  renderChart();
}

function renderFiltroDocentes(){
  const sel=filterDocente.value;
  filterDocente.innerHTML='<option value="">Todos</option>';
  Object.keys(docenteColors).forEach(d=>{
    filterDocente.innerHTML+=`<option value="${d}">${d}</option>`;
  });
  filterDocente.value=sel;
}

/* ---------- CALENDAR ---------- */
function prevMonth(){currentDate.setMonth(currentDate.getMonth()-1);syncUI();}
function nextMonth(){currentDate.setMonth(currentDate.getMonth()+1);syncUI();}
function syncUI(){
  filterMes.value=currentDate.getMonth();
  filterYear.value=currentDate.getFullYear();
  renderCalendar();
}

function renderCalendar(){
  calendar.innerHTML="";
  const m=currentDate.getMonth();
  const y=currentDate.getFullYear();

  monthLabel.textContent=currentDate.toLocaleString("es",{month:"long",year:"numeric"});

  const grid=document.createElement("div");
  grid.className="month-grid";

  const first=new Date(y,m,1).getDay();
  const days=new Date(y,m+1,0).getDate();

  for(let i=0;i<first;i++) grid.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const date=`${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML=`<h3>${d}</h3>`;
    cell.onclick=()=>openDialog(date);

    citas.filter(c=>c.fecha===date && (!filterDocente.value||c.docente===filterDocente.value))
      .forEach(c=>{
        const ev=document.createElement("div");
        ev.className="event";
        ev.style.background=docenteColors[c.docente];
        ev.style.top=((parseInt(c.hora)-8)*20)+"px";
        ev.textContent=`${c.hora} ${c.alumno}`;
        ev.onclick=e=>{e.stopPropagation();openDialog(c.fecha,c.hora,c);};
        cell.appendChild(ev);
      });

    grid.appendChild(cell);
  }
  calendar.appendChild(grid);
}

/* ---------- DIALOG ---------- */
function openDialog(fecha,hora="08:00",c=null){
  citaId.value=c?.id||"";
  fecha.value=fecha;
  hora.value=hora;
  docente.value=c?.docente||"";
  curso.value=c?.curso||"";
  alumno.value=c?.alumno||"";
  apoderado.value=c?.apoderado||"";
  dialog.showModal();
}

function closeDialog(){dialog.close();}

/* ---------- SAVE / DELETE ---------- */
async function guardar(){
  const params=new URLSearchParams({
    action:citaId.value?"edit":"add",
    id:citaId.value,
    fecha:fecha.value,
    hora:hora.value,
    docente:docente.value,
    curso:curso.value,
    alumno:alumno.value,
    apoderado:apoderado.value
  });
  await fetch(SHEET_URL+"?"+params);
  closeDialog();cargarCitas();
}

async function eliminar(){
  if(!citaId.value||!confirm("¿Eliminar cita?"))return;
  await fetch(`${SHEET_URL}?action=delete&id=${citaId.value}`);
  closeDialog();cargarCitas();
}

/* ---------- CHART ---------- */
function renderLegend(){
  legendDiv.innerHTML="";
  Object.keys(docenteColors).forEach(d=>{
    legendDiv.innerHTML+=`
      <div class="legend-item">
        <div class="legend-color" style="background:${docenteColors[d]}"></div>${d}
      </div>`;
  });
}

function renderChart(){
  const ctx=document.getElementById("chart").getContext("2d");
  if(window.chart)window.chart.destroy();
  window.chart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(docenteColors),
      datasets:[{data:Object.keys(docenteColors).map(d=>citas.filter(c=>c.docente===d).length),
        backgroundColor:Object.values(docenteColors)}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

/* ---------- START ---------- */
initFilters();
cargarCitas();
</script>

</body>
</html>
